# 1️⃣ 도메인에 대한 이해 과정

## 1.1. 계근지란? (by. 나무위키)

계근지 영수증(계근표, Weighbridge Ticket)은 **화물을 적재한 차량의 중량을 계근대(저울)에서 측정**한 후, **그 결과를 기록하여 발급**하는 증빙 서류

주로 수출입 컨테이너(VGM), 건설 폐기물, 고철, 농산물 등의 거래나 운송 시 무게를 증명하기 위해 사용

즉, 화물 차량이 폐기물이나 원자재를 싣고 들어올 때, **[물건을 싣기 전의 무게]**와 **[싣고 난 후의 무게]**를 측정하여 그 차이값(실제 물건의 무게)을 증명하는 용도

## 1.2. 샘플 데이터 분석

> **계근지 (차량의 총중량 / 공차 / 실중량 등을 포함한 영수증 형태)**의 OCR 결과 텍스트
> 
- `sample_03.json`
    
    ```json
    {
      "apiVersion":"1.1",
      "confidence":0.9108,
      "metadata":
      {
        "pages": [
          {
            "height":1920,
            "page":1,
            "width":1440
          }
        ]
      },
      "mimeType":"multipart/form-data",
      "modelVersion":"ocr-250904",
      "numBilledPages":1,
      "pages": [
        {
          "confidence":0.9108,
          "height":1920,
          "id":0,
          "text":"** 계 량 확 인 서 ** \n(공급자 보관용) \n없다. \nN \n계량 일자: 2026-02-01 5 \n차량 번호: 5405 입고 \n회 사 명 : \n제 품 명 : \n총 중 량 : 11시 33분 14,080 kg \n공차중량 : 11시 39분 13,950 kg \n실 중 량 : 130 kg \n공육을 unle \n정우리사이클링 (주) \n경기도 화성시 팔탄면 노하길454번길 23 \nTel) 031-354-7778 \n* 상기와 같이 계량하였음을 증명합니다. * \n2026-02-01 11:55:35",
          "width":1440,
          "words": [ // 바운딩 박스 배열
            {
              "boundingBox": {
                "vertices": [
                  {"x":193,"y":244},
                  {"x":270,"y":243},
                  {"x":271,"y":282},
                  {"x":194,"y":283}
                ]
              },
              "confidence":0.9937,
              "id":0,
              "text":"**"
            },
            {
              "boundingBox": {
                "vertices": [
                  {"x":316,"y":232},
                  {"x":388,"y":233},
                  {"x":387,"y":299},
                  {"x":316,"y":298}
                ]
              },
              "confidence":0.9624,
              "id":1,
              "text":"계"
            },
            {
              "boundingBox": {
                "vertices": [
                  {"x":441,"y":230},
                  {"x":513,"y":229},
                  {"x":514,"y":295},
                  {"x":442,"y":295}
                ]
              },
              "confidence":0.9663,
              "id":2,
              "text":"량"
            },
            {
              "boundingBox": {
                "vertices": [
                  {"x":563,"y":227},
                  {"x":634,"y":227},
                  {"x":634,"y":292},
                  {"x":563,"y":292}
                ]
              },
              "confidence":0.9294,
              "id":3,
              "text":"확"
            },
    //        ...
            ,
            {
              "boundingBox": {
                "vertices": [
                  {"x":240,"y":1810},
                  {"x":395,"y":1810},
                  {"x":395,"y":1842},
                  {"x":240,"y":1842}
                ]
              },
              "confidence":0.9842,
              "id":65,
              "text":"11:55:35"
            }
          ],
          "text":"2026-02-01 11:55:35",
          "boundingBox": [
            {
              "vertices": [
                {"x":27,"y":1808},
                {"x":226,"y":1809},
                {"x":226,"y":1843},
                {"x":26,"y":1843}
              ]
            }, {
              "vertices":[{"x":240,"y":1810},{"x":395,"y":1810},{"x":395,"y":1842},{"x":240,"y":1842}]}],
          "confidence":0.9755499999999999}]}
      ],
      "stored":false,
      "text":"** 계 량 확 인 서 ** \n(공급자 보관용) \n없다. \nN \n계량 일자: 2026-02-01 5 \n차량 번호: 5405 입고 \n회 사 명 : \n제 품 명 : \n총 중 량 : 11시 33분 14,080 kg \n공차중량 : 11시 39분 13,950 kg \n실 중 량 : 130 kg \n공육을 unle \n정우리사이클링 (주) \n경기도 화성시 팔탄면 노하길454번길 23 \nTel) 031-354-7778 \n* 상기와 같이 계량하였음을 증명합니다. * \n2026-02-01 11:55:35"
    }
    ```
    

### **1.2.1. 메타 데이터 분석**

- `confidence: 0.9108`: OCR 엔진이 스스로 판단한 텍스트 인식의 전체 정확도입니다. (약 91%)
- `width/height`: 스캔된 원본 이미지의 해상도(1440x1920)입니다.

### 1.2.2. 텍스트 데이터 분석

- `text`: 문서 전체의 줄바꿈(`\n`)이 포함된 원문. 파싱 로직의 주 입력값이 됩니다.
- `words`: 개별 단어 단위의 정보입니다.
    - **텍스트 내용:** `계`, `량`, `확`, `인` 등.
    - **신뢰도(Confidence):** 각 글자별 인식 정확도.
    - **바운딩 박스(Bounding Box):** 해당 글자가 이미지 상의 어느 좌표(`x`, `y`)에 위치하는지

### 1.2.3. 샘플 텍스트 분석

```text
**계 량 확 인 서**
(공급자 보관용)
없다. 
N
계량 일자: 2026-02-01 5 
차량 번호: 5405 입고 
회 사 명 : 
제 품 명 : 
총 중 량 : 11시 33분 14,080 kg 
공차중량 : 11시 39분 13,950 kg
실 중 량 : 130 kg 
공육을 unle
정우리사이클링 (주) 
경기도 화성시 팔탄면 노하길454번길 23 
Tel) 031-354-7778 
* 상기와 같이 계량하였음을 증명합니다. * 
2026-02-01 11:55:35
```

- **거래 주체:** 정우리사이클링 (주)
- **측정 대상:** 5405 차량
- **물리적 흐름:**
    1. **총중량 (14,080kg):** 오전 11:33 측정. (물건을 실은 상태의 차량 무게)
    2. **공차중량 (13,950kg):** 오전 11:39 측정. (물건을 내리거나 싣기 전 비어있는 차량 무게)
    3. **실중량 (130kg):** 실제 거래되는 물품의 순수 무게.
- **위치 및 시각:** 2026년 2월 1일 오전 11:55에 경기도 화성시 팔탄면에서 발행됨.

<br>

## 1.3. 계근지를 OCR 엔진으로 스캔했을 때, 발생할 수 있는 문제

### **1. 필드 데이터 내 노이즈 중간 삽입**

- **시각 데이터 침범:** `총 중 량 : 11시 33분 14,080 kg` 처럼 라벨과 수치 사이에 측정 시각이 끼어들 수 있음.
    - 단순 문자열 슬라이싱이나 `:` 뒤의 첫 번째 덩어리를 가져오는 로직 사용 시, 숫자가 아닌 `11시`를 무게로 인식할 오류가 큼.
- **불필요한 접미사:** `차량 번호: 5405 입고`에서 '입고'라는 단어가 붙어 있어, 순수 차량 번호만 추출하기 위한 별도의 처리가 필요함.

### **2. 레이블(Label) 인식의 불규칙성**

OCR이 글자 사이의 간격을 어떻게 인식하느냐에 따라 매칭 실패가 발생할 수 있음.

- **가변적 공백:** `총 중 량`, `공차중량`, `실 중 량` 등 어떤 항목은 띄어쓰기가 있고 어떤 항목은 없기도 함.
- **의미 없는 파편 데이터:** `없다.`, `N`, `공육을 unle` 처럼 계량기 화면의 잔상이나 수기 기록이 섞여 들어와 데이터 필드와 혼동될 수 있음.

### **3. 수치 및 단위의 불안정성**

수치 단위에 대한 노이즈가 가장 치명적이라고 판단.

- **천단위 구분 기호와 소수점 혼동:** `14,080`의 콤마(`,`)가 노이즈로 인해 점(`.`)으로 인식될 경우, `14,080kg`이 `14.08kg`으로 변해버릴 위험이 있음.
- **단위 인식 오류:** `kg`이 `ko`, `kg.`, `k g` 등으로 인식될 경우 수치 데이터의 정확한 상태를 알기 어려워짐.
- **날짜 데이터 중복:** `2026-02-01 5`와 하단의 `2026-02-01 11:55:35` 중 어떤 것이 실제 거래 기준일자인지 모호함
    - 상단 날짜의 `5`는 오인식된 노이즈일 가능성이 있음.

### **4. 논리적 정합성 위배 (Logical Inconsistency)**

추출된 데이터들 간의 관계가 비즈니스 로직과 충돌할 수 있음

- 보통 **총중량(적재) 측정 후 공차중량(빈 차)을 측정**한다고 함
    - 샘플 JSON에서는 `11:33(총중량)` -> `11:39(공차중량)` 순서
    - 하지만 만약 OCR 오류로 시각이 뒤바뀌어 인식된다면 입/출고 프로세스 판정 자체가 꼬이게 됨.
    - 따라서, 시간 순서에 따라 차량 출입 시간을 명시해야 함.
- **계산 불일치 위험:**
    - 만약 `130 kg`이 `180 kg`으로 잘못 읽혔을 때, **14,080 - 13,950 = 130** 이라는 산술 결과와 충돌할 수 있음.
    - 따라서, 어느 데이터를 신뢰할 지 크로스 체크가 필요함

---

# 2️⃣ 요구사항 분석

## 2.1. 문제 요구사항 분석

- 입력
    - **계근지 (차량의 총중량 / 공차 / 실중량 등을 포함한 영수증 형태)** 의 OCR 결과 텍스트
- 로직
    - OCR 텍스트의 노이즈 (띄어쓰기 / 오탈자 / 순서 변경 / 라벨 누락 / 숫자 포맷 불규칙 등)를 고려한 파싱
        - 직접 파싱 로직을 구현하거나, 오픈소스 파싱 엔진 (spaCy) 활용
    - 업무에 필요한 필드를 정확하고 견고하게 파싱하여 구조화
- 출력
    - JSON / CSV 등 구조화 형태로 저장

## 2.2. OCR 텍스트의 노이즈 해결 전략

### **2.2.1. 데이터 정규화 (1) - 텍스트 에러 검출**

> OCR 엔진의 특성상 발생하는 물리적 노이즈를 먼저 제거하고 정규화하기

- **공백 및 특수문자 제거**
    - `회 사 명` → `회사명`, `총 중 량` → `총중량` 등 공백을 제거하여 데이터 포맷 통일
- **유사 문자 치환**
    - OCR 과정에서 발생할 수 있는 숫자 오인식 문자를 교정
    - 예: `O → 0, I/l → 1, S → 5, B → 8`
- **불용어 제거**
    - 의미 없는 파편 데이터(`N`, `없다.`, `*`)
    - 상투적인 문구 (차랑번호: 5405 입고 → `입고`)

<br>

### **2.2.2. 데이터 정규화 (2) - 기타 노이즈 해결**

> 라벨과 값 사이에 노이즈가 끼어들거나 순서가 바뀌는 상황 등을 해결하기

- **정규표현식 매칭**
    - 정규식을 활용하여, 라벨과 단위 사이의 어떤 노이즈도 건너뛰고 핵심 수치만 추출
- **좌표 기반 재구성**
    - `\n`으로 인해 비정상적으로 줄바꿈이 꼬인 경우 → `boundingBox` 정보를 활용해야 함.
    - 같은 `y` 좌표를 가진 단어들을 하나의 행으로 묶어서 텍스트를 재구성 하는 방식으로 적용
- **라벨 누락 대응**
    - 라벨이 인식되지 않았을 때, 총중량, 공차중량, 실중량의 값이 누락될 수 있음.
    - `총중량` - `공차중량` = `실중량` 이므로, 값들을 내림차순하여 무게 값에 각각 총중량, 공차중량, 실중량을 배치

<br>

### **2.2.3. 데이터 표준화**

> 다양한 숫자 표기법과 오인식된 기호 정제하기

- **천단위/소수점 정밀 처리**
    - 한국 계근지 특성상 무게는 보통 정수(kg)
    - 마침표(`.`)가 찍혔더라도 앞뒤 문맥을 보아 천단위 구분 기호(`,`)로 판단되면 제거 후 정수로 변환
- **단위 환산 로직**
    - `ton`과 `kg`이 혼용될 경우, 단위를 인식하여 내부 시스템 기준(예: `kg`)으로 수치를 환산 저장

<br>

### **2.2.4. 수치 정합성 체크**

> OCR 결과와 실제 계산 로직 결과가 일치하지 않는 경우, 한 번 더 체크해야 한다.


- **무게 삼각 검증:** `총중량` - `공차중량` = `실중량`
    - 만약 불일치할 경우, `실중량` 값보다는 총중량과 공차중량의 차이를 먼저 신뢰 하거나 `'검토 필요'` 와 같은 플래그변수를 할당해서 클라이언트가 직접 검증을 할 수 있도록 적용하기
- **날짜 및 시간 선후 관계 검증:**
    - 입고 시각과 출고 시각의 선후 관계를 확인하여 데이터의 신뢰성을 확보
- **중복 값 우선순위:**
    - 동일한 정보(날짜 등)가 여러 번 등장할 경우, 신뢰도가 더 높은 텍스트 뭉치에서 추출한 값을 선택

<br>

## 2.3. 기능 파이프라인 총정리

> OCR 텍스트의 노이즈 해결 전략에 따라, 비즈니스 로직 설계

1. **Pre-processing:** OCR 텍스트의 불필요한 공백 제거, 특수문자 정규화.
2. **Pattern Matching:** 정규표현식(Regex)을 사용해 날짜, 시간, 차량 번호 등 패턴이 명확한 데이터 추출.
3. **Named Entity Recognition (NER):** spaCy 라이브러리를 활용해 '업체명'이나 '품목'처럼 패턴화하기 어려운 텍스트 추출.
4. **Validation**: 실제 입력 받은 OCR 텍스트 검증